<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gestion des Produits</title>

<!-- SUPABASE -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ====== STYLE IDENTIQUE (non modifi√©) ====== */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Segoe UI,Tahoma,Verdana,sans-serif;background:#f5f5f5;padding:2rem}
.container{max-width:1200px;margin:auto}
header{background:#fff;padding:2rem;border-radius:12px;margin-bottom:2rem;display:flex;justify-content:space-between;align-items:center}
.btn{background:#667eea;color:#fff;border:none;padding:.8rem 1.5rem;border-radius:6px;font-weight:600;cursor:pointer}
.btn-success{background:#28a745}
.btn-danger{background:#dc3545}
.btn-secondary{background:#6c757d}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:2rem}
.product-card{background:#fff;border-radius:12px;overflow:hidden}
.product-image{width:100%;height:200px;object-fit:cover}
.product-info{padding:1.5rem}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#fff;padding:2rem;border-radius:12px;width:90%;max-width:600px}
.form-group{margin-bottom:1rem}
.form-group input,.form-group textarea{width:100%;padding:.8rem}
.alert{position:fixed;top:20px;right:20px;background:#28a745;color:#fff;padding:1rem;border-radius:6px}
</style>
</head>

<body>

<div class="container">
<header>
<h1>üì¶ Gestion des Produits</h1>
<button class="btn btn-success" onclick="openAddModal()">+ Ajouter un produit</button>
</header>

<div id="products-container"></div>
</div>

<!-- MODAL -->
<div id="product-modal" class="modal">
<div class="modal-content">
<h2 id="modal-title">Ajouter un produit</h2>

<form id="product-form">
<input type="hidden" id="product-id">

<div class="form-group">
<input id="product-name" placeholder="Nom du produit" required>
</div>

<div class="form-group">
<input type="number" id="product-price" placeholder="Prix" required>
</div>

<div class="form-group">
<textarea id="product-description" placeholder="Description"></textarea>
</div>

<div class="form-group">
<input id="product-image" placeholder="Lien image">
</div>

<button class="btn btn-success" type="submit">Enregistrer</button>
<button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
</form>
</div>
</div>

<script>
console.log("CMS charg√© OK");

// üîê CONFIG SUPABASE
const SUPABASE_URL = "https://rwrxteyjdoyvddsisupi.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_y5PWYTfGkVQIl0sv4ZCiJg_9WlxPdv7";

// ‚úÖ INITIALISATION SAFE (ANTI DOUBLE D√âCLARATION)
if (!window.supabaseClient) {
    window.supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
    );
}
const supabase = window.supabaseClient;

let products = [];
let editingId = null;

// üì• Charger produits
async function loadProducts() {
    const { data } = await supabase.from("products").select("*").order("id",{ascending:false});
    products = data || [];
    displayProducts();
}

// üì¶ Affichage
function displayProducts() {
    const c = document.getElementById("products-container");
    if (!products.length) {
        c.innerHTML = "<p>Aucun produit</p>";
        return;
    }
    c.innerHTML = `
        <div class="products-grid">
        ${products.map((p,i)=>`
            <div class="product-card">
                <img class="product-image" src="${p.image||''}">
                <div class="product-info">
                    <b>${p.name}</b><br>
                    ${p.price} FCFA<br>
                    <button class="btn" onclick="editProduct(${i})">Modifier</button>
                    <button class="btn btn-danger" onclick="deleteProduct(${p.id})">Supprimer</button>
                </div>
            </div>
        `).join("")}
        </div>
    `;
}

// ‚ûï Modal
function openAddModal(){
    editingId=null;
    document.getElementById("product-form").reset();
    document.getElementById("product-modal").classList.add("active");
}
function closeModal(){
    document.getElementById("product-modal").classList.remove("active");
}

// ‚úèÔ∏è Modifier
function editProduct(i){
    const p=products[i];
    editingId=p.id;
    product-name.value=p.name;
    product-price.value=p.price;
    product-description.value=p.description||"";
    product-image.value=p.image||"";
    openAddModal();
}

// ‚ùå Supprimer
async function deleteProduct(id){
    await supabase.from("products").delete().eq("id",id);
    loadProducts();
}

// üíæ Sauvegarde
document.getElementById("product-form").addEventListener("submit",async e=>{
    e.preventDefault();
    const data={
        name:product-name.value,
        price:+product-price.value,
        description:product-description.value,
        image:product-image.value
    };
    if(editingId){
        await supabase.from("products").update(data).eq("id",editingId);
    }else{
        await supabase.from("products").insert([data]);
    }
    closeModal();
    loadProducts();
});

loadProducts();
</script>

</body>
</html>
